<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:title" content="Running Flutter integration tests in Docker"><meta property="og:description" content="Why and How we run integration tests in Docker"><meta property="og:type" content="article"><meta property="og:url" content="/2021/12/running-flutter-integration-tests-in-docker/"><meta property="article:published_time" content="2021-12-28T09:49:36+07:00"><meta property="article:modified_time" content="2022-01-04T14:46:00+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running Flutter integration tests in Docker"><meta name=twitter:description content="Why and How we run integration tests in Docker"><meta name=generator content="Hugo 0.126.0"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Running Flutter integration tests in Docker","url":"/2021/12/running-flutter-integration-tests-in-docker/","wordCount":"598","datePublished":"2021-12-28T09:49:36+07:00","dateModified":"2022-01-04T14:46:00+07:00","author":{"@type":"Person","name":"phamnhuvu-dev"},"keywords":"DevSecOps, Testing, docker, integration-test, flutter, dart","description":"Why and How we run integration tests in Docker"}</script><link rel=canonical href=/2021/12/running-flutter-integration-tests-in-docker/><title>Running Flutter integration tests in Docker | Manabie Tech Blog</title>
<link href=/css/style.beb8012edc08ba10be012f079d618dc243812267efe62e11f22fe49618f976a4.css rel=stylesheet integrity="sha256-vrgBLtwIuhC+AS8HnWGNwkOBImfv5i4R8i/klhj5dqQ=" crossorigin=anonymous><script defer src=/js/fontawesome.min.f5072c55a0721857184db93a50561d7dc13975b4de2e19db7f81eb5f3fa57270.js integrity="sha256-9QcsVaByGFcYTbk6UFYdfcE5dbTeLhnbf4HrXz+lcnA=" crossorigin=anonymous></script><script src=/js/haven.umd.min.5f4a3edd16edd243f2a9b07dbf1b371f8f1b18fbb29319aba09431678609a175.js integrity="sha256-X0o+3Rbt0kPyqbB9vxs3H48bGPuykxmroJQxZ4YJoXU=" crossorigin=anonymous></script><script>Haven.create({notification:{styles:{background:"#428bca",textColor:"#ffffff",buttonBackgroundColor:"#f71559",buttonTextColor:"#ffffff"}},translations:{en:{notification:{policy:"Learn more.",message:"This website uses cookies.",accept:"Agree",decline:"Disagree"}}},services:[{name:"google-analytics",options:{id:"G-EJ2GNQJNM6"},purposes:["analytics"],inject:!0}]})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EJ2GNQJNM6"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EJ2GNQJNM6")}</script><style>div.highlight>pre{padding:1rem}</style></head><body><div class=blog-masthead><div class=container><nav class="nav blog-nav"><a class=nav-link href=/>Home</a></nav></div></div><header class=blog-header><div class=container><h1 class=blog-title dir=auto><a href=/ rel=home>Manabie Tech Blog</a></h1><p class="lead blog-description" dir=auto>Sharing the humble technical knowledge we&rsquo;re using to improve education</p></div></header><div class=container><div class=row><div class="col-sm-8 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=/2021/12/running-flutter-integration-tests-in-docker/>Running Flutter integration tests in Docker</a></h2><p class=blog-post-meta><time datetime=2021-12-28T09:49:36+07:00>Tue Dec 28, 2021</time>
in
<span class="fas fa-folder" aria-hidden=true></span>&nbsp;<a href=/categories/devsecops/ rel="category tag">DevSecOps</a>, <a href=/categories/testing/ rel="category tag">Testing</a>
<span class="fas fa-tag" aria-hidden=true></span>&nbsp;<a href=/tags/docker/ rel=tag>docker</a>, <a href=/tags/integration-test/ rel=tag>integration-test</a>, <a href=/tags/flutter/ rel=tag>flutter</a>, <a href=/tags/dart/ rel=tag>dart</a></p></header><h1 id=running-flutter-integration-tests-in-docker>Running Flutter integration tests in Docker</h1><h2 id=prerequisite>Prerequisite</h2><ul><li>Linux OS</li><li>Installing:<ul><li>Flutter</li><li>Docker</li><li>Docker compose</li><li>KVM <a href=https://help.ubuntu.com/community/KVM/Installation>https://help.ubuntu.com/community/KVM/Installation</a></li></ul></li></ul><h2 id=technologies>Technologies</h2><ul><li><p>Flutter:</p><ul><li>Google&rsquo;s SDK for crafting beautiful, fast user experiences for mobile, web, and desktop from a single codebase. Flutter works with existing code, is used by developers and organizations around the world, and is free and open source.</li><li><a href=https://github.com/flutter/flutter>https://github.com/flutter/flutter</a></li></ul></li><li><p>Docker:</p><ul><li>An open platform for developing, shipping, and running applications</li><li><a href=https://docs.docker.com/get-started/overview/>https://docs.docker.com/get-started/overview/</a></li></ul></li><li><p>Android Emulator container:</p><ul><li>Allowing you to find and run the right version of the Emulator without the headache of dependency management, which makes it easy to scale automated tests as part of a CI/CD system without the upkeep cost of a physical device farm</li><li><a href=https://github.com/google/android-emulator-container-scripts>https://github.com/google/android-emulator-container-scripts</a></li></ul></li></ul><h2 id=why-we-use-docker-to-run-automation-tests>Why we use Docker to run automation tests</h2><ul><li><p>Scaling tests:</p><ul><li>Docker provides the ability to package and run an application in a loosely isolated environment, so we can run multiple e2e tests parallel.</li></ul></li><li><p>Reusing:</p><ul><li>Our Dockerfile file and docker-compose.yml file is simple because of reusing container from the community.</li></ul></li><li><p>Consistency:</p><ul><li>Allowing developers to work in standardized environments using local containers which provide applications and services</li></ul></li><li><p>Responsive:</p><ul><li>Docker containers can run on a developerâ€™s local laptop and on cloud providers.</li></ul></li></ul><h2 id=explanation>Explanation</h2><ul><li>We create Dockerfile for the flutter-app service because we need to copy our source code to the container to build then run tests</li></ul><pre tabindex=0><code>FROM cirrusci/flutter:2.8.1

RUN sdkmanager &#34;build-tools;29.0.2&#34;

RUN flutter precache --android --no-web --no-ios --no-universal

COPY pubspec.* .

RUN --mount=type=cache,sharing=locked,target=/flutter flutter pub get

WORKDIR /project

COPY . .
</code></pre><ul><li>To run the Flutter integration test we need a process for Android Emulator and a process for Flutter drive. That is why we have 2 services: <code>flutter-app</code> and <code>android-emulator</code> in <code>docker-compose.yml</code> file.</li></ul><pre tabindex=0><code>version: &#34;3.9&#34;
services:
  android-emulator:
    image: us-docker.pkg.dev/android-emulator-268719/images/30-google-x64:30.1.2
    devices:
      - /dev/kvm

  flutter-app:
    depends_on:
      - android-emulator
    build: .
    command: make run-test
</code></pre><ul><li><p>But <code>flutter-app</code> and <code>android-emulator</code> are 2 separate services. It means they are not the same network, so we need to connect <code>flutter-app</code> to <code>android-emulator</code> by the following command: <code>adb connect android-emulator:5555</code>. Reference: <a href=https://developer.android.com/studio/command-line/adb#wireless>https://developer.android.com/studio/command-line/adb#wireless</a></p></li><li><p>After <code>flutter-app</code> connected to <code>android-emulator</code>, we can run the Flutter integration tests with <code>flutter drive</code> command. We combine connect emulator script and flutter drive script in <code>run-test</code> command in <code>Makefile</code>.</p></li></ul><pre tabindex=0><code>run-test:
	sleep 10
	adb connect android-emulator:5555
	adb wait-for-device
	bash waiting-for-boot.sh
	flutter pub get
	flutter drive --target test_driver/app.dart
</code></pre><h2 id=run-the-example>Run the example</h2><ul><li>Cloning the source code on Github: <a href=https://github.com/phamnhuvu-dev/flutter_android_docker>https://github.com/phamnhuvu-dev/flutter_android_docker</a></li><li>After cloning the source code, move to the root of the source code.</li><li>Run <code>make run-docker-test</code></li><li>If you see the following log after running the above command. You succeeded.</li></ul><pre tabindex=0><code>All tests passed!
</code></pre><h2 id=summary>Summary:</h2><ul><li>Using docker for automation tests is being used widely in the software industry, not only Mobile field.</li><li>With Docker&rsquo;s ability, scaling tests is far easier and faster, helping us to detect breakings and bugs quickly to fix and maintain.</li><li>Maybe you have the same question as almost all mobile developers who&rsquo;re using macOS to work. How can we run the automation tests on macOS before shipping the source code to the cloud?<ol><li>We can&rsquo;t run <code>android-emulator x64</code> container on macOS because the macOS doesn&rsquo;t have KVM.</li><li>Actually, we can run <code>android-emulator arm</code> with <code>-no-accel</code> but the performance is very bad => can&rsquo;t use on Intel chip macOS</li><li>Running <code>android-emulator arm</code> on ARM chip macOS:<ul><li>Google is working on that: <a href=https://github.com/google/android-emulator-container-scripts/issues/211>https://github.com/google/android-emulator-container-scripts/issues/211</a></li><li>Self-building <code>android-emulator arm</code> image <a href=https://github.com/google/android-emulator-container-scripts>https://github.com/google/android-emulator-container-scripts</a>. I am using Intel macOS so I don&rsquo;t have ARM macOS to do this. I am waiting for the next M1X Mac mini with 32GB ram, 16GB ram is not enough for me for something paralleling and scaling.</li></ul></li><li>Connecting <code>flutter-app</code> service from container to Android Emulator on macOS, yes we can do that I will write a blog for this.</li></ol></li></ul><hr><footer><div class=meta_item><span class=meta_text>About <a href=/author/phamnhuvu-dev>phamnhuvu-dev</a></span><br><i></i></div><hr><section><h4>Share</h4><nav class="nav sharing-icons"><a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=%2f2021%2f12%2frunning-flutter-integration-tests-in-docker%2f" title="Share on Facebook"><span class="fab fa-facebook-f fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2f2021%2f12%2frunning-flutter-integration-tests-in-docker%2f" title="Share on LinkedIn"><span class="fab fa-linkedin-in fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://twitter.com/intent/tweet?url=%2f2021%2f12%2frunning-flutter-integration-tests-in-docker%2f&amp;text=Running%20Flutter%20integration%20tests%20in%20Docker" title="Tweet this"><span class="fab fa-twitter fa-2x"></span></a></nav></section><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//manabie.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><section class=sidebar-module><h4>Links</h4><ol class=list-unstyled><li><a href=https://manabie.com>About Us</a></li><li><a href=https://manabie.breezy.hr>Careers</a></li></ol></section></aside></div></div><footer class=blog-footer><p dir=auto>Except where otherwise noted, content on this site is licensed under a <a href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution 4.0 International license</a>.</p><p><a href=#>Back to top</a></p></footer></body></html>